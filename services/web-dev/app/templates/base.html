<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="The Whitebox contest submission server">
    <meta name="author" content="CryptoExperts">

    <title>The WhibOx contest - CTF CHES 2019</title>

    <!-- Bootstrap core CSS -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">

    <!-- MetisMenu CSS -->
    <link href="/static/css/metisMenu.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="/static/css/sb-admin-2.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="/static/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- Perso css -->
    <link href="/static/css/perso.css" rel="stylesheet" type="text/css">


  </head>

  <body>

    <div id="wrapper">

      {% include 'navigation.html' %}

      <!-- Page Content -->
      <div id="page-wrapper">

	<div class="row">
          <div class="col-lg-12">
            <h1 class="page-header">{% block title %}{% endblock %}</h1>
          </div>
          <!-- /.col-lg-12 -->
        </div>


	{% with messages = get_flashed_messages(with_categories=True) %}
	  {% if messages %}
	    <div class="alerts-container">
	      {% for message in messages %}
		<div class="alert alert-{{ message[0] }} fade in" role="alert">
		  <span>{{ message[1] }}</span>
		</div>
	      {% endfor %}
	    </div>
	  {% endif %}
	{% endwith %}

	{% block content %}{% endblock %}

      </div><!-- /#page-wrapper -->


    </div><!-- #wrapper -->


    <!-- jQuery -->
    <script src="/static/js/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/static/js/bootstrap.min.js"></script>

    <!-- Metis Menu Plugin JavaScript -->
    <script src="/static/js/metisMenu.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="/static/js/sb-admin-2.min.js"></script>

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="/static/js/ie10-viewport-bug-workaround.js"></script>

    <!-- Plotting -->
    <script src="/static/js/excanvas.min.js"></script>
    <script src="/static/js/jquery.flot.js"></script>
    <script src="/static/js/jquery.flot.resize.js"></script>
    <script src="/static/js/jquery.flot.time.js"></script>

    <!-- Data tables -->
    <!-- DataTables JavaScript -->
    <script src="/static/js/jquery.dataTables.min.js"></script>
    <script src="/static/js/dataTables.bootstrap.min.js"></script>
    <script src="/static/js/dataTables.responsive.js"></script>
    <script src="/static/js/data-table.js"></script>

    <!-- Custom js for notifications -->
    <script src="/static/js/notify-crx.js"></script>

    <script type="text/javascript">
      $(function() {
	  function getProgramsToPlot() {
	      var programs = [{% if programs_to_plot %} {% for program in programs_to_plot %}{id:{{ program._id }},name:"{{ program._funny_name }}",ts_publish:{{program._timestamp_published}},ts_break:{{program._timestamp_first_break or -1}},ts_invert:{{ program._timestamp_first_inversion or -1 }},performance:{{ program._performance_factor }},color:"{{ program.hsl_color }}"}, {% endfor %} {% endif %}];
	      return programs;
	  }

	  function dataGrowth(start, end, factor) {
	      var minutes = Math.floor((end-start)/60);
	      return [...Array(minutes+1).keys()].map(i => [start*1000 + i*60000, factor*Math.pow(i/1440,2)]);
	  }

	  function dataDecrease(start, peak, end, factor) {
	      var minutes_before_peak = Math.floor((peak-start)/60);
	      var minutes_after_peak = Math.floor((end-peak)/60);
	      // TODO: pick the minimum between before peak and after peak
	      return [...Array(minutes_after_peak).keys()].map(i => [peak*1000 + i*60000, factor*Math.pow((minutes_before_peak-i)/1440,2)]);
	  }

	  function getData() {
	      var now = Math.floor(Date.now() / 1000);
	      var programs = getProgramsToPlot();
	      var strawberries = [];
	      var carrots = [];
	      programs.forEach(function(p) {
		  var strawberry_curve;
		  if (p.ts_break > 0) {
		      strawberry_curve1 = dataGrowth(p.ts_publish, p.ts_break, p.performance);
		      strawberry_curve2 = dataDecrease(p.ts_publish, p.ts_break, now, p.performance);
		      strawberry_curve = strawberry_curve1.concat(strawberry_curve2);
		  } else {
		      strawberry_curve = dataGrowth(p.ts_publish, now, p.performance);
		  }
		  strawberries.push({
		      color: p.color,
		      label: p.name + " (" + p.id + ")&nbsp;&nbsp;",
                      data: strawberry_curve
		  });

		  var carrot_curve;
		  ts_peak = now;
		  if (p.ts_break > 0 || p.ts_invert > 0) {
		      if (p.ts_break > 0) {
			  ts_peak = p.ts_break;
		      }
		      if (p.ts_invert > 0) {
			  ts_peak = Math.min(p.ts_invert, ts_peak);
		      }
		      carrot_curve1 = dataGrowth(p.ts_publish, ts_peak, 0.5*p.performance);
		      carrot_curve2 = dataDecrease(p.ts_publish, ts_peak, now, 0.5*p.performance);
		      carrot_curve = carrot_curve1.concat(carrot_curve2);
		  } else {
		      carrot_curve1 = dataGrowth(p.ts_publish, now, 0.5*p.performance);
		  }

		  carrots.push({
		      color: p.color,
		      label: p.name + " (" + p.id + ")&nbsp;&nbsp;",
                      data: carrot_curve
		  });
              });

	      return [strawberries, carrots];
	  }

	  // Set up the control widget
	  var updateInterval = 60000;
	  $("#updateInterval").val(updateInterval).change(function () {
	      var v = $(this).val();
	      if (v && !isNaN(+v)) {
		  updateInterval = +v;
		  if (updateInterval < 1) {
		      updateInterval = 1;
		  } else if (updateInterval > 2000) {
		      updateInterval = 2000;
		  }
		  $(this).val("" + updateInterval);
	      }
	  });

	  var data = getData();
	  var plotStrawberry = $.plot("#strawberryholder", data[0] , {
	      series: {shadowSize: 0},
	      yaxis: {min: 0, position: "right"},
	      xaxis: { show: true, mode: "time", timeformat: "%m/%d" },
	      legend: { position: "nw", noColumns: 2, margin: 10}
	  });
	  var plotCarrot = $.plot("#carrotholder", data[1] , {
	      series: {shadowSize: 0},
	      yaxis: {min: 0, position: "right"},
	      xaxis: { show: true, mode: "time", timeformat: "%m/%d" },
	      legend: { position: "nw", noColumns: 2, margin: 10}
	  });
	  function update() {
	      console.log("update chart at: ", Date());
	      var data = getData()
	      plotStrawberry.setData(data[0]);
	      plotStrawberry.draw();
	      plotCarrot.setData(data[1]);
	      plotCarrot.draw();
	      setTimeout(update, updateInterval);
	  }
	  update();
      });
    </script>

  </body>
</html>
